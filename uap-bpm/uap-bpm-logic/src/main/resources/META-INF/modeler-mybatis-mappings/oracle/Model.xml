<?xml version="1.0" encoding="UTF-8" ?> 

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hexing.uap.bpm.app.domain.editor.Model">

    <resultMap id="modelResultMap" type="com.hexing.uap.bpm.app.domain.editor.Model">
        <id property="id" column="ID" jdbcType="VARCHAR" />
        <result property="name" column="NAME" jdbcType="VARCHAR" />
        <result property="key" column="MODEL_KEY" jdbcType="VARCHAR" />
        <result property="description" column="DESCRIPTION" jdbcType="VARCHAR" />
        <result property="comment" column="MODEL_COMMENT" jdbcType="VARCHAR" />
        <result property="created" column="CREATED" jdbcType="TIMESTAMP" />
        <result property="createdBy" column="CREATED_BY" jdbcType="VARCHAR" />
        <result property="lastUpdated" column="LAST_UPDATED" jdbcType="TIMESTAMP" />
        <result property="lastUpdatedBy" column="LAST_UPDATED_BY" jdbcType="VARCHAR" />
        <result property="version" column="VERSION" jdbcType="INTEGER" />
        <result property="modelEditorJson" column="MODEL_EDITOR_JSON" jdbcType="VARCHAR" />
        <result property="modelType" column="MODEL_TYPE" jdbcType="INTEGER" />
        <result property="thumbnail" column="THUMBNAIL" jdbcType="${blobType}"/>
        <result property="tenantId" column="TENANT_ID" jdbcType="VARCHAR" />
    </resultMap>

    <insert id="insertModel" parameterType="com.hexing.uap.bpm.app.domain.editor.Model">
        insert into ${prefix}ACT_DE_MODEL (
            ID,
            NAME,
            MODEL_KEY,
            DESCRIPTION,
            MODEL_COMMENT,
            CREATED,
            CREATED_BY,
            LAST_UPDATED,
            LAST_UPDATED_BY,
            VERSION,
            MODEL_EDITOR_JSON,
            MODEL_TYPE,
            THUMBNAIL,
            TENANT_ID)
         values (
            #{id, jdbcType=VARCHAR},
            #{name, jdbcType=VARCHAR},
            #{key, jdbcType=VARCHAR},
            #{description, jdbcType=VARCHAR},
            #{comment, jdbcType=VARCHAR},
            #{created, jdbcType=TIMESTAMP},
            #{createdBy, jdbcType=VARCHAR},
            #{lastUpdated, jdbcType=TIMESTAMP},
            #{lastUpdatedBy, jdbcType=VARCHAR},
            #{version, jdbcType=INTEGER},
            #{modelEditorJson, jdbcType=VARCHAR},
            #{modelType, jdbcType=INTEGER},
            #{thumbnail,jdbcType=${blobType}},
            #{tenantId, jdbcType=VARCHAR}
          )
    </insert>
    
    <update id="updateModel" parameterType="com.hexing.uap.bpm.app.domain.editor.Model">
        update ${prefix}ACT_DE_MODEL
        <set>
            NAME = #{name, jdbcType=VARCHAR},
            MODEL_KEY = #{key, jdbcType=VARCHAR},
            DESCRIPTION = #{description, jdbcType=VARCHAR},
            MODEL_COMMENT = #{comment, jdbcType=VARCHAR},
            CREATED = #{created, jdbcType=TIMESTAMP},
            CREATED_BY = #{createdBy, jdbcType=VARCHAR},
            LAST_UPDATED = #{lastUpdated, jdbcType=TIMESTAMP},
            LAST_UPDATED_BY = #{lastUpdatedBy, jdbcType=VARCHAR},
            VERSION = #{version, jdbcType=INTEGER},
            MODEL_EDITOR_JSON = #{modelEditorJson, jdbcType=VARCHAR},
            MODEL_TYPE = #{modelType, jdbcType=INTEGER},
            THUMBNAIL = #{thumbnail, jdbcType=${blobType}},
            TENANT_ID = #{tenantId, jdbcType=VARCHAR}
        </set>
        where ID = #{id, jdbcType=VARCHAR}
    </update>
    
    <select id="selectModel" parameterType="string" resultMap="modelResultMap">
        select * from ${prefix}ACT_DE_MODEL where ID = #{id, jdbcType=VARCHAR}
    </select>
    
    <select id="selectModelByParentModelId" parameterType="string" resultMap="modelResultMap">
       select model.* from ${prefix}ACT_DE_MODEL_RELATION modelrelation 
       inner join ${prefix}ACT_DE_MODEL model on modelrelation.MODEL_ID = model.ID
       where modelrelation.PARENT_MODEL_ID = #{parentModelId, jdbcType=VARCHAR}
    </select>
    
    <select id="selectModelByParameters" parameterType="map" resultMap="modelResultMap">
        select * from ${prefix}ACT_DE_MODEL
        <where>
            <if test="modelType != null">
               MODEL_TYPE = #{modelType, jdbcType=INTEGER}
            </if>
            <if test="filter != null">
               and (lower(NAME) like #{filter, jdbcType=VARCHAR} or lower(DESCRIPTION) like #{filter, jdbcType=VARCHAR})
            </if>
            <if test="key != null">
               and MODEL_KEY = #{key, jdbcType=VARCHAR}
            </if>
            <if test="tenantId != null and tenantId != '' ">
               and TENANT_ID = #{tenantId, jdbcType=VARCHAR}
            </if>
        </where>
        <if test="sort != null">
            <if test="sort == 'nameAsc'">
                order by NAME asc
            </if>
            <if test="sort == 'nameDesc'">
                order by NAME desc
            </if>
            <if test="sort == 'modifiedAsc'">
                order by LAST_UPDATED asc
            </if>
            <if test="sort == 'modifiedDesc'">
                order by LAST_UPDATED desc
            </if>
        </if>
    </select>
    
    <select id="countByModelTypeAndCreatedBy" parameterType="map">
       select count(m.ID) from ${prefix}ACT_DE_MODEL m
       where m.CREATED_BY = #{createdBy, jdbcType=VARCHAR} and m.MODEL_TYPE = #{modelType, jdbcType=INTEGER}
      <if test="tenantId != null and tenantId != '' ">
         and TENANT_ID = #{tenantId, jdbcType=VARCHAR}
      </if>
    </select>

    <delete id="deleteModel" parameterType="com.hexing.uap.bpm.app.domain.editor.Model">
        delete from ${prefix}ACT_DE_MODEL where ID = #{id}
    </delete>
    
</mapper>